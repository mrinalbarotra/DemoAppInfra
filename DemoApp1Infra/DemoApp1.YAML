trigger:
  branches: 
    include:
      - main

parameters:
  - name: environment
    displayName: "Select Environment"
    type: string
    default: Dev
    values:
      - Dev
      - Prod

pool:
  name: "default"

variables:
  TF_IN_AUTOMATION: "true" #Tells Terraform that it is running in an automated environment (CI/CD)
  TF_INPUT: "false"   #Disables interactive input prompts. Terraform will fail immediately if a variable value is missing
  #terraform.tfvars path on agent
  BASE_TFVARS_DIR: "/home/Mrinal/Documents/VSCode/Terraform/DemoApp/DemoApp1Infra/Environments"
  #part of terraform.tfvars folder path changing as per selected environment
  TFVARS_PATH: "$(BASE_TFVARS_DIR)/${{ parameters.environment }}/terraform.tfvars" #${{}} compile time expression
  TF_WORKING_DIR: "$(Build.SourcesDirectory)/${{ parameters.environment }}" #Define TF_WORKING_DIR as a pipeline variable

stages:
  - stage: Terraform
    displayName: "Run the selected environment terraform code"

    jobs:
      - job: terraform
        displayName: "Create resources as per the selected environment"

        steps:
          - checkout: self #clone the directory/repo where tfvar is to the agents working directory"
            clean: true #tells AzureDevops to clean the agents working directory before checkout, deleting old run data as working directory is reused"

          - script: |
              terraform init -var-file=$(TFVARS_PATH)
            displayName: "Terraform init"
            workingDirectory: $(TF_WORKING_DIR)

          - script: |
              terraform validate -var-file=$(TFVARS_PATH)
            displayName: "Terraform Validate"
            workingDirectory: $(TF_WORKING_DIR)

          - script: |
              tflint --init
              tflint
            displayName: "Tflint scanning"
            workingDirectory: $(TF_WORKING_DIR)

          - script: |
              terraform plan -var-file=$(TFVARS_PATH)
            displayName: "Terraform Plan"
            workingDirectory: $(TF_WORKING_DIR)

          - script: |
              terraform apply -var-file=$(TFVARS_PATH)
                --auto-approve
            displayName: "Terraform Apply"
            workingDirectory: $(TF_WORKING_DIR)